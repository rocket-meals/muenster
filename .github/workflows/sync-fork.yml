name: üîÑ Fork Synchronization

on:
  # Run hourly
  schedule:
    - cron: '0 * * * *'  # Every hour at minute 0
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  sync-fork:
    name: üîÑ Sync Fork with Upstream
    runs-on: ubuntu-latest
    
    steps:
      - name: üîç Check if Repository is a Fork
        id: check-fork
        run: |
          REPO_FULL_NAME="${{ github.repository }}"
          echo "Current repository: $REPO_FULL_NAME"
          
          if [ "$REPO_FULL_NAME" = "rocket-meals/rocket-meals" ]; then
            echo "This is the upstream repository. Skipping sync."
            echo "is_fork=false" >> $GITHUB_OUTPUT
          else
            echo "This is a fork. Proceeding with sync."
            echo "is_fork=true" >> $GITHUB_OUTPUT
          fi

      - name: üîÑ Checkout Repository
        if: steps.check-fork.outputs.is_fork == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: üîç Check for Upstream Changes
        if: steps.check-fork.outputs.is_fork == 'true'
        id: check-updates
        run: |
          git remote add upstream https://github.com/rocket-meals/rocket-meals.git
          git fetch upstream master
          LOCAL=$(git rev-parse master)
          UPSTREAM=$(git rev-parse upstream/master)
          if [ "$LOCAL" = "$UPSTREAM" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: üîß Setup GitHub CLI
        if: steps.check-fork.outputs.is_fork == 'true' && steps.check-updates.outputs.has_updates == 'true'
        run: |
          # GitHub CLI is pre-installed on Ubuntu runners
          gh --version

          # Authenticate with GitHub CLI using the token
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: üîÑ Sync Fork with Upstream
        if: steps.check-fork.outputs.is_fork == 'true' && steps.check-updates.outputs.has_updates == 'true'
        run: |
          REPO_FULL_NAME="${{ github.repository }}"
          echo "Syncing fork: $REPO_FULL_NAME"
          echo "Upstream repository: rocket-meals/rocket-meals"
          echo "Target branch: master"

          # Sync the fork with the upstream repository using --force to handle conflicts
          gh repo sync "$REPO_FULL_NAME" -b master --force

          echo "‚úÖ Fork synchronization completed successfully!"

      - name: ‚è≠Ô∏è No changes to synchronize
        if: steps.check-fork.outputs.is_fork == 'true' && steps.check-updates.outputs.has_updates == 'false'
        run: |
          echo "‚è≠Ô∏è No changes detected. Skipping fork synchronization."

      - name: ‚è≠Ô∏è Skip Fork Sync
        if: steps.check-fork.outputs.is_fork == 'false'
        run: |
          echo "‚è≠Ô∏è Skipping fork synchronization - this is the upstream repository."
