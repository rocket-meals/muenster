name: üîÑ Fork Synchronization

permissions:
  contents: write

on:
  # Run hourly
  schedule:
    - cron: '0 0 * * *'  # Runs at 00:00. 

  # Allow manual triggering
  workflow_dispatch:

jobs:
  sync-fork:
    name: üîÑ Sync Fork with Upstream
    runs-on: ubuntu-latest
    
    steps:
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Check Repository Type
        id: check-repo
        uses: ./.github/actions/check-repository

      - name: üîç Check for Updates from Upstream
        id: check-updates
        if: steps.check-repo.outputs.is-fork == 'true'
        run: |
          # Fetch upstream repository
          git remote add upstream https://github.com/rocket-meals/rocket-meals.git || true
          git fetch upstream master
          
          # Check if there are differences
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/master)
          
          echo "Local commit: $LOCAL_COMMIT"
          echo "Upstream commit: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "Updates available from upstream"
            echo "has-updates=true" >> $GITHUB_OUTPUT
          else
            echo "No updates available"
            echo "has-updates=false" >> $GITHUB_OUTPUT
          fi

      - name: üîÑ Sync Fork with Upstream
        id: sync-result
        if: steps.check-repo.outputs.is-fork == 'true' && steps.check-updates.outputs.has-updates == 'true'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_ACCESS_TOKEN }}
        run: |
          REPO_FULL_NAME="${{ steps.check-repo.outputs.repository-name }}"
          echo "Syncing fork: $REPO_FULL_NAME"
          echo "Upstream repository: rocket-meals/rocket-meals"
          echo "Target branch: master"

          # Sync the fork with the upstream repository using --force to handle conflicts
          if gh repo sync "$REPO_FULL_NAME" -b master --force; then
            echo "‚úÖ Fork synchronization completed successfully!"
            echo "sync-success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Fork synchronization failed!"
            echo "sync-success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: üöÄ Trigger Combined CI
        if: steps.check-repo.outputs.is-fork == 'true' && steps.sync-result.outputs.sync-success == 'true'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_ACCESS_TOKEN }}
        run: |
          echo "üöÄ Triggering Combined CI workflow after successful sync..."
          gh workflow run combined-ci.yml --ref master
          echo "‚úÖ Combined CI workflow triggered!"

      - name: ‚è≠Ô∏è Skip Fork Sync - No Updates
        if: steps.check-repo.outputs.is-fork == 'true' && steps.check-updates.outputs.has-updates == 'false'
        run: |
          echo "‚è≠Ô∏è No updates available from upstream - skipping sync."

      - name: ‚è≠Ô∏è Skip Fork Sync - Upstream Repository
        if: steps.check-repo.outputs.is-fork == 'false'
        run: |
          echo "‚è≠Ô∏è Skipping fork synchronization - this is the upstream repository."
