name: ğŸš€ Unified CI

on:
  push:
    branches: [main,master,dev]
  workflow_dispatch: # Allow manual triggering

jobs:
  setup:
    name: ğŸ§° Setup and Install
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  check-build:
    name: ğŸ” Check Build Number
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
      - name: ğŸ” Compare Build Number
        id: check
        uses: ./.github/actions/check-build-number

  check-repository:
    name: ğŸ” Check Repository
    runs-on: ubuntu-latest
    outputs:
      is-upstream: ${{ steps.check.outputs.is-upstream }}
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
      - name: ğŸ” Check Repository Type
        id: check
        uses: ./.github/actions/check-repository

  sonarqube:
    name: ğŸ” SonarQube Analysis
    runs-on: ubuntu-latest
    needs: check-repository
    if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: ğŸ” SonarQube Scan
        if: ${{ env.SONAR_TOKEN != '' }}
        uses: SonarSource/sonarqube-scan-action@1a6d90ebcb0e6a6b1d87e37ba693fe453195ae25 # v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  sonarcloud-report:
    name: ğŸ“¥ Download SonarCloud Report
    runs-on: ubuntu-latest
    needs: [sonarqube, check-repository]
    if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ“¥ Download SonarCloud reports
        run: |
          SONAR_PROJECT=$(grep -E '^sonar.projectKey' sonar-project.properties | cut -d= -f2)
          OUTPUT_DIR=reports
          echo "Saving SonarCloud reports to $OUTPUT_DIR"
          yarn workspace sonarCloudReportDownloader start --token "$SONAR_TOKEN" --project "$SONAR_PROJECT" --output-dir "$OUTPUT_DIR"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      - name: ğŸ’¾ Commit reports
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          if [ -d apps/sonarCloudReportDownloader/reports ]; then
            echo "Committing reports from apps/sonarCloudReportDownloader/reports"
            git add -f apps/sonarCloudReportDownloader/reports
            git commit -m "chore: update sonarcloud reports" || echo "No changes to commit"
            git push
          else
            echo "No reports generated at apps/sonarCloudReportDownloader/reports, skipping commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  backend-directus:
    name: ğŸ”¨ Directus Backend Build
    runs-on: ubuntu-latest
    needs: check-build
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ğŸš€ Build backend
        uses: ./.github/actions/backend-build
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  expo-update:
    name: ğŸ— EAS Update Production
    runs-on: ubuntu-latest
    needs: check-build
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: master
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸš€ Publish update
        run: eas update --auto --platform all --non-interactive --channel production
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-android:
    name: ğŸ“¦ Build & ğŸš€ Submit Android App
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: master
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ› ï¸ Build and Submit Android App
        run: eas build --platform android --non-interactive --profile production --auto-submit
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-android-preview:
    name: ğŸ§ª Build Android Preview APK
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ§ª Build with previewApk profile
        run: eas build --platform android --non-interactive --profile previewApk
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-ios:
    name: ğŸ“¦ Build & ğŸš€ Submit iOS App
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: master
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ› ï¸ Build and Submit iOS App
        run: eas build --platform ios --non-interactive --auto-submit
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  deploy-gh-pages:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: check-build
    if: github.ref == 'refs/heads/master'
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ‘¤ Git User Configuration
        run: |
          git config --global user.name 'Rocket Meals'
          git config --global user.email 'nils@baumgartner-software.de'
      - name: ğŸš€ Deploy to GitHub Pages
        run: |
          git remote set-url origin https://git:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          CI=false yarn deploy:gh:pages
        working-directory: ./apps/frontend/app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
