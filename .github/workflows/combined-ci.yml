name: ğŸš€ Unified CI

on:
  push:
    branches: [main,master]

jobs:
  setup:
    name: ğŸ§° Setup and Install
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  check-build:
    name: ğŸ” Check Build Number
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3
      - name: ğŸ” Compare Build Number
        id: check
        uses: ./.github/actions/check-build-number

  backend-directus:
    name: ğŸ”¨ Directus Backend Build
    runs-on: ubuntu-latest
    needs: check-build
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: ğŸš€ Build backend
        uses: ./.github/actions/backend-build
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  expo-update:
    name: ğŸ— EAS Update Production
    runs-on: ubuntu-latest
    needs: check-build
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: master
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸš€ Publish update
        run: eas update --auto --platform all --non-interactive --channel production
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-android:
    name: ğŸ“¦ Build & ğŸš€ Submit Android App
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: master
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ› ï¸ Build and Submit Android App
        run: eas build --platform android --non-interactive --profile production --auto-submit
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-android-preview:
    name: ğŸ§ª Build Android Preview APK
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ§ª Build with previewApk profile
        run: eas build --platform android --non-interactive --profile previewApk
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-ios:
    name: ğŸ“¦ Build & ğŸš€ Submit iOS App
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: master
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ› ï¸ Build and Submit iOS App
        run: eas build --platform ios --non-interactive --auto-submit
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  deploy-gh-pages:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: check-build
    if: github.ref == 'refs/heads/master'
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3
      - name: ğŸ§° Setup Node.js, Yarn & Dependencies
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: ğŸ‘¤ Git User Configuration
        run: |
          git config --global user.name 'Rocket Meals'
          git config --global user.email 'nils@baumgartner-software.de'
      - name: ğŸš€ Deploy to GitHub Pages
        run: |
          git remote set-url origin https://git:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          CI=false yarn deploy:gh:pages
        working-directory: ./apps/frontend/app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
