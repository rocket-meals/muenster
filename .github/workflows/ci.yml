name: "ğŸš€ CI"

on:
  push:
    branches: [main, master, dev]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-repository:
    name: "ğŸ” Check Repository"
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip ci]')
    outputs:
      is-upstream: ${{ steps.check.outputs.is-upstream }}
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
      - name: "ğŸ” Check Repository Type"
        id: check
        uses: ./.github/actions/check-repository

  check-build:
    name: "ğŸ” Check Build Number"
    runs-on: ubuntu-latest
    needs: check-repository
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
      - name: "ğŸ” Compare Build Number"
        id: check
        uses: ./.github/actions/check-build-number

#  lint:
#    name: "ğŸ¨ Prettier & ESLint"
#    runs-on: ubuntu-latest
#    needs: [check-build, check-repository]
#    steps:
#      - name: "ğŸ”„ Checkout Repository"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#          token: ${{ secrets.GITHUB_TOKEN }}
#      - name: "ğŸ§° Setup Node.js, Yarn & Dependencies"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        uses: ./.github/actions/setup-and-install
#        with:
#          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
#      - name: "ğŸ¨ Prettier"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        run: yarn format
#      - name: "âœ¨ ESLint"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        run: yarn lint
#      - name: "ğŸ“¤ Commit linting changes"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        run: |
#          git config user.name "github-actions"
#          git config user.email "github-actions@github.com"
#          git diff --quiet || (git add -A && git commit -m "chore: apply lint fixes [skip ci]" && git push)

#  sonarqube:
#    name: "ğŸ” SonarQube Analysis"
#    runs-on: ubuntu-latest
#    needs: [lint, check-repository]
#    continue-on-error: true
#    steps:
#      - name: "ğŸ”„ Checkout Repository"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        uses: actions/checkout@v4
#        with:
#          ref: ${{ github.ref_name }}
#          fetch-depth: 0
#      - name: "ğŸ” SonarQube Scan"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' && env.SONAR_TOKEN != '' }}
#        uses: SonarSource/sonarqube-scan-action@1a6d90ebcb0e6a6b1d87e37ba693fe453195ae25 # v5
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

#  sonarcloud-report:
#    name: "ğŸ“¥ Download SonarCloud Report"
#    runs-on: ubuntu-latest
#    needs: [sonarqube, data-clumps-report, check-repository]
#    continue-on-error: true
#    steps:
#      - name: "ğŸ”„ Checkout Repository"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        uses: actions/checkout@v4
#        with:
#          ref: ${{ github.ref_name }}
#          fetch-depth: 0
#          token: ${{ secrets.GITHUB_TOKEN }}
#      - name: "ğŸ§° Setup Node.js, Yarn & Dependencies"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        uses: ./.github/actions/setup-and-install
#        with:
#          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
#      - name: "ğŸ“¥ Download SonarCloud reports"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        run: |
#          SONAR_PROJECT=$(grep -E '^sonar.projectKey' sonar-project.properties | cut -d= -f2)
#          yarn workspace sonarCloudReportDownloader start --token "$SONAR_TOKEN" --project "$SONAR_PROJECT"
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#      - name: "ğŸ’¾ Commit reports"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        run: |
#          git config user.name "github-actions"
#          git config user.email "github-actions@github.com"
#          git pull --rebase --autostash origin "$GITHUB_REF_NAME"
#          if [ -d reports/sonarCloud ]; then
#            echo "Committing reports from reports/sonarCloud"
#            git add -f reports/sonarCloud
#            if git diff --cached --quiet; then
#              echo "No changes to commit"
#            else
#              git commit -m "chore: update sonarcloud reports [skip ci]"
#              git push
#            fi
#          else
#            echo "No reports generated at reports/sonarCloud, skipping commit"
#          fi
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#  data-clumps-report:
#    name: "ğŸ©º Analyse Data Clumps"
#    runs-on: ubuntu-latest
#    needs: [lint, check-repository]
#    steps:
#      - name: "ğŸ”„ Checkout Repository"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        uses: actions/checkout@v4
#        with:
#          ref: ${{ github.ref_name }}
#          fetch-depth: 0
#          token: ${{ secrets.GITHUB_TOKEN }}
#      - name: "âš™ï¸ Setup Node.js"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        uses: actions/setup-node@v4
#        with:
#          node-version: "22.16.0"
#      - name: "ğŸ©º Analyse data clumps"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        uses: NilsBaumgartner1994/data-clumps-doctor/.github/actions/analyse-data-clumps@master
#        with:
#          path-to-source: .
#          output-path: reports/data-clumps-doctor/data-clumps.json
#          badge-output-path: reports/data-clumps-doctor/badges/data-clumps.svg
#          source-language-type: typescript
#      - name: "ğŸ’¾ Commit reports"
#        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#        run: |
#          git config user.name "github-actions"
#          git config user.email "github-actions@github.com"
#          git pull --rebase --autostash origin "$GITHUB_REF_NAME"
#          if [ -d reports/data-clumps-doctor ]; then
#            echo "Committing reports from reports/data-clumps-doctor"
#            git add -f reports/data-clumps-doctor
#            if git diff --cached --quiet; then
#              echo "No changes to commit"
#            else
#              git commit -m "chore: update data clumps report [skip ci]"
#              git push
#            fi
#          else
#            echo "No reports generated at reports/data-clumps-doctor, skipping commit"
#          fi
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  backend-directus:
    name: "ğŸ”¨ Directus Backend Build"
    runs-on: ubuntu-latest
#    needs: sonarcloud-report
    needs: [check-build, check-repository]
    steps:
      - name: "ğŸ— Setup repo"
        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
      - name: "ğŸš€ Build backend"
        if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
        uses: ./.github/actions/backend-build
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  expo-update:
    name: "ğŸ— EAS Update Production"
    runs-on: ubuntu-latest
    #    needs: sonarcloud-report
    needs: [check-build, check-repository]
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
        with:
          ref: master
      - name: "ğŸ§° Setup Node.js, Yarn & Dependencies"
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: "ğŸš€ Publish update"
        run: eas update --auto --platform all --non-interactive --channel production
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-android:
    name: "ğŸ“¦ Build & ğŸš€ Submit Android App"
    runs-on: ubuntu-latest
#    needs: [sonarcloud-report, check-build]
    needs: [check-build, check-repository]
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
        with:
          ref: master
      - name: "ğŸ§° Setup Node.js, Yarn & Dependencies"
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: "ğŸ› ï¸ Build and Submit Android App"
        run: eas build --platform android --non-interactive --profile production --auto-submit
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-android-preview:
    name: "ğŸ§ª Build Android Preview APK"
    runs-on: ubuntu-latest
#    needs: [sonarcloud-report, check-build]
    needs: [check-build, check-repository]
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
      - name: "ğŸ§° Setup Node.js, Yarn & Dependencies"
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: "ğŸ§ª Build with previewApk profile"
        run: eas build --platform android --non-interactive --profile previewApk
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-ios:
    name: "ğŸ“¦ Build & ğŸš€ Submit iOS App"
    runs-on: ubuntu-latest
#    needs: [sonarcloud-report, check-build]
    needs: [check-build, check-repository]
    if: needs.check-build.outputs.changed == 'true'
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
        with:
          ref: master
      - name: "ğŸ§° Setup Node.js, Yarn & Dependencies"
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: "ğŸ› ï¸ Build and Submit iOS App"
        run: eas build --platform ios --non-interactive --auto-submit
        working-directory: ./apps/frontend/app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  deploy-gh-pages:
    name: "ğŸŒ Deploy to GitHub Pages"
    runs-on: ubuntu-latest
#    needs: sonarcloud-report
    needs: [check-build, check-repository]
    if: github.ref_name == 'master'
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
      - name: "ğŸ§° Setup Node.js, Yarn & Dependencies"
        uses: ./.github/actions/setup-and-install
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - name: "ğŸ‘¤ Git User Configuration"
        run: |
          git config --global user.name 'Rocket Meals'
          git config --global user.email 'nils@baumgartner-software.de'
      - name: "ğŸš€ Deploy to GitHub Pages"
        run: |
          git remote set-url origin https://git:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          CI=false yarn deploy:gh:pages
        working-directory: ./apps/frontend/app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#  push-changes:
#    name: "ğŸ“¤ Push Changes"
#    runs-on: ubuntu-latest
#    needs: [backend-directus, sonarcloud-report, data-clumps-report, check-repository]
#    if: ${{ needs.check-repository.outputs.is-upstream == 'true' }}
#    steps:
#      - name: "ğŸ”„ Checkout Repository"
#        uses: actions/checkout@v4
#        with:
#          ref: ${{ github.ref_name }}
#          fetch-depth: 0
#          token: ${{ secrets.GITHUB_TOKEN }}
#      - name: "ğŸ“¤ Push accumulated changes"
#        run: |
#          git config user.name "github-actions"
#          git config user.email "github-actions@github.com"
#          git push